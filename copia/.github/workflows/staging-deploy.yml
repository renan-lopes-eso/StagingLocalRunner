name: Staging Deploy

on:
  push:
    branches:
      - main
      - staging/**
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Windows, staging]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract branch info
        id: branch
        shell: powershell
        run: |
          $branch = "${{ github.ref_name }}"
          $branchSafe = $branch -replace '[^a-zA-Z0-9]', '-'
          $commitShort = "${{ github.sha }}".Substring(0,7)

          # Calcular porta baseada no hash da branch (5000-5999)
          $hash = 0
          foreach ($char in $branchSafe.ToCharArray()) { $hash += [int]$char }
          $port = 5000 + ($hash % 1000)

          echo "branch=$branch" >> $env:GITHUB_OUTPUT
          echo "branch_safe=$branchSafe" >> $env:GITHUB_OUTPUT
          echo "commit_short=$commitShort" >> $env:GITHUB_OUTPUT
          echo "port=$port" >> $env:GITHUB_OUTPUT

          Write-Host "Branch: $branch"
          Write-Host "Branch Safe: $branchSafe"
          Write-Host "Port: $port"

      - name: Build Docker image
        shell: powershell
        run: |
          $imageName = "eso-testrunner"
          $tag = "${{ steps.branch.outputs.branch_safe }}"

          Write-Host "Building image: ${imageName}:${tag}" -ForegroundColor Yellow

          docker build -t "${imageName}:${tag}" -f ESO.TestRunner/Dockerfile ESO.TestRunner/

          Write-Host "Image built successfully!" -ForegroundColor Green

      - name: Stop old container
        shell: powershell
        continue-on-error: true
        run: |
          $containerName = "staging-${{ steps.branch.outputs.branch_safe }}"

          Write-Host "Stopping container: $containerName" -ForegroundColor Yellow

          docker stop $containerName 2>$null
          docker rm $containerName 2>$null

          Write-Host "Old container removed" -ForegroundColor Green

      - name: Run new container
        shell: powershell
        run: |
          $containerName = "staging-${{ steps.branch.outputs.branch_safe }}"
          $imageName = "eso-testrunner:${{ steps.branch.outputs.branch_safe }}"
          $port = "${{ steps.branch.outputs.port }}"

          Write-Host "Starting container: $containerName on port $port" -ForegroundColor Yellow

          docker run -d `
            --name $containerName `
            --restart unless-stopped `
            -p "${port}:80" `
            -e ASPNETCORE_ENVIRONMENT=Staging `
            -e BRANCH_NAME="${{ steps.branch.outputs.branch }}" `
            -e COMMIT_SHA="${{ github.sha }}" `
            -e ESO_CORE_CONNECTION="${{ secrets.ESO_CORE_CONNECTION }}" `
            $imageName

          Write-Host "Container started!" -ForegroundColor Green

      - name: Health check
        shell: powershell
        run: |
          $port = "${{ steps.branch.outputs.port }}"
          $url = "http://localhost:$port"
          $maxRetries = 10
          $retryCount = 0

          Write-Host "Waiting for application to start..." -ForegroundColor Yellow

          while ($retryCount -lt $maxRetries) {
            try {
              $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "Application is healthy!" -ForegroundColor Green
                exit 0
              }
            }
            catch {
              $retryCount++
              Write-Host "Attempt $retryCount/$maxRetries - Waiting..."
              Start-Sleep -Seconds 3
            }
          }

          Write-Host "Application may not be fully ready, but container is running" -ForegroundColor Yellow

      - name: Show running containers
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "=== Containers rodando ===" -ForegroundColor Cyan
          docker ps --filter "name=staging-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Summary
        shell: powershell
        run: |
          $port = "${{ steps.branch.outputs.port }}"

          echo "## Deploy Successful! :rocket:" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "| Item | Valor |" >> $env:GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ steps.branch.outputs.branch }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ steps.branch.outputs.commit_short }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| **Container** | staging-${{ steps.branch.outputs.branch_safe }} |" >> $env:GITHUB_STEP_SUMMARY
          echo "| **URL** | http://localhost:$port |" >> $env:GITHUB_STEP_SUMMARY
